<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Seurat | 一盏烛光的微笑灿烂人生</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3129839_xft6cqs5gc.css">
    <noscript><meta http-equiv="refresh" content="0; url=https://www.youngkbt.cn/noscript/"><style>.theme-vdoing-content { display:none }</noscript>
    <meta name="description" content="学习记录博客">
    <meta name="theme-color" content="#11a8cd">
    <meta name="个人博客" content="科研学习，围炉夜话，奇淫巧计">
    
    <link rel="preload" href="/assets/css/0.styles.c9ffc21e.css" as="style"><link rel="preload" href="/assets/js/app.bd488e07.js" as="script"><link rel="preload" href="/assets/js/2.bdf5b8cf.js" as="script"><link rel="preload" href="/assets/js/51.65eba0cc.js" as="script"><link rel="preload" href="/assets/js/3.365ac406.js" as="script"><link rel="prefetch" href="/assets/js/10.b00b53b4.js"><link rel="prefetch" href="/assets/js/100.1b2ba6dd.js"><link rel="prefetch" href="/assets/js/101.e392eb92.js"><link rel="prefetch" href="/assets/js/102.eb0bb162.js"><link rel="prefetch" href="/assets/js/103.9db14406.js"><link rel="prefetch" href="/assets/js/104.6ae6fd5c.js"><link rel="prefetch" href="/assets/js/105.4d79399b.js"><link rel="prefetch" href="/assets/js/106.4e6ff12d.js"><link rel="prefetch" href="/assets/js/107.bc93ee73.js"><link rel="prefetch" href="/assets/js/108.59a000f0.js"><link rel="prefetch" href="/assets/js/109.f01f4422.js"><link rel="prefetch" href="/assets/js/11.346d31c6.js"><link rel="prefetch" href="/assets/js/110.96a96c44.js"><link rel="prefetch" href="/assets/js/111.87fe63df.js"><link rel="prefetch" href="/assets/js/112.c560a316.js"><link rel="prefetch" href="/assets/js/113.6a371b02.js"><link rel="prefetch" href="/assets/js/114.989a4d3e.js"><link rel="prefetch" href="/assets/js/115.b6baafa2.js"><link rel="prefetch" href="/assets/js/116.d469dc20.js"><link rel="prefetch" href="/assets/js/117.0a6bccf0.js"><link rel="prefetch" href="/assets/js/118.9f1ef088.js"><link rel="prefetch" href="/assets/js/119.059ef806.js"><link rel="prefetch" href="/assets/js/12.8d91a638.js"><link rel="prefetch" href="/assets/js/120.75ed11ab.js"><link rel="prefetch" href="/assets/js/121.1896ee22.js"><link rel="prefetch" href="/assets/js/122.a3664290.js"><link rel="prefetch" href="/assets/js/123.5b849c39.js"><link rel="prefetch" href="/assets/js/124.85737d6b.js"><link rel="prefetch" href="/assets/js/125.a95cd42f.js"><link rel="prefetch" href="/assets/js/126.7b1c1645.js"><link rel="prefetch" href="/assets/js/127.64a16fd4.js"><link rel="prefetch" href="/assets/js/128.a07721ba.js"><link rel="prefetch" href="/assets/js/129.9ba86871.js"><link rel="prefetch" href="/assets/js/13.18ed2aa7.js"><link rel="prefetch" href="/assets/js/130.5cdb8138.js"><link rel="prefetch" href="/assets/js/131.d2f31425.js"><link rel="prefetch" href="/assets/js/132.b2286d65.js"><link rel="prefetch" href="/assets/js/133.1229c9ae.js"><link rel="prefetch" href="/assets/js/134.71fad9a0.js"><link rel="prefetch" href="/assets/js/135.ff682301.js"><link rel="prefetch" href="/assets/js/136.9de1870b.js"><link rel="prefetch" href="/assets/js/137.a58bbdcd.js"><link rel="prefetch" href="/assets/js/138.cc768cb1.js"><link rel="prefetch" href="/assets/js/139.9d52d34a.js"><link rel="prefetch" href="/assets/js/14.4bcf7ee9.js"><link rel="prefetch" href="/assets/js/140.b1790e58.js"><link rel="prefetch" href="/assets/js/141.98bceb9f.js"><link rel="prefetch" href="/assets/js/142.0415d712.js"><link rel="prefetch" href="/assets/js/143.851c7187.js"><link rel="prefetch" href="/assets/js/144.ae79e007.js"><link rel="prefetch" href="/assets/js/145.d5020e58.js"><link rel="prefetch" href="/assets/js/146.c3eafa98.js"><link rel="prefetch" href="/assets/js/147.0a6864ec.js"><link rel="prefetch" href="/assets/js/148.bbc4bd28.js"><link rel="prefetch" href="/assets/js/149.489e8cdb.js"><link rel="prefetch" href="/assets/js/15.368d9d2d.js"><link rel="prefetch" href="/assets/js/150.7778d444.js"><link rel="prefetch" href="/assets/js/16.06f68354.js"><link rel="prefetch" href="/assets/js/17.4f8d6256.js"><link rel="prefetch" href="/assets/js/18.8989b2ff.js"><link rel="prefetch" href="/assets/js/19.abb857ca.js"><link rel="prefetch" href="/assets/js/20.e32420cf.js"><link rel="prefetch" href="/assets/js/21.06441c4d.js"><link rel="prefetch" href="/assets/js/22.7fb78c64.js"><link rel="prefetch" href="/assets/js/23.d9193b83.js"><link rel="prefetch" href="/assets/js/24.6487f43a.js"><link rel="prefetch" href="/assets/js/25.11e66938.js"><link rel="prefetch" href="/assets/js/26.c3e43726.js"><link rel="prefetch" href="/assets/js/27.24117748.js"><link rel="prefetch" href="/assets/js/28.fabf32c7.js"><link rel="prefetch" href="/assets/js/29.3a9331f2.js"><link rel="prefetch" href="/assets/js/30.ac5ca451.js"><link rel="prefetch" href="/assets/js/31.36e6c9c0.js"><link rel="prefetch" href="/assets/js/32.2fcf84e2.js"><link rel="prefetch" href="/assets/js/33.a73adf6b.js"><link rel="prefetch" href="/assets/js/34.49c0fb46.js"><link rel="prefetch" href="/assets/js/35.babda623.js"><link rel="prefetch" href="/assets/js/36.56221bac.js"><link rel="prefetch" href="/assets/js/37.5d6d33aa.js"><link rel="prefetch" href="/assets/js/38.a6b592e0.js"><link rel="prefetch" href="/assets/js/39.14a81539.js"><link rel="prefetch" href="/assets/js/4.a64d5c9f.js"><link rel="prefetch" href="/assets/js/40.e94616b3.js"><link rel="prefetch" href="/assets/js/41.4ad9febc.js"><link rel="prefetch" href="/assets/js/42.4825ff11.js"><link rel="prefetch" href="/assets/js/43.6d554f8a.js"><link rel="prefetch" href="/assets/js/44.ed8f011b.js"><link rel="prefetch" href="/assets/js/45.170e103d.js"><link rel="prefetch" href="/assets/js/46.9cc703a7.js"><link rel="prefetch" href="/assets/js/47.ff6af7ea.js"><link rel="prefetch" href="/assets/js/48.1b2f1a1b.js"><link rel="prefetch" href="/assets/js/49.05223958.js"><link rel="prefetch" href="/assets/js/5.b1fd9f62.js"><link rel="prefetch" href="/assets/js/50.26aa9f07.js"><link rel="prefetch" href="/assets/js/52.5b21c37d.js"><link rel="prefetch" href="/assets/js/53.4f209254.js"><link rel="prefetch" href="/assets/js/54.176923ed.js"><link rel="prefetch" href="/assets/js/55.74f6741d.js"><link rel="prefetch" href="/assets/js/56.383e3c0d.js"><link rel="prefetch" href="/assets/js/57.35b21350.js"><link rel="prefetch" href="/assets/js/58.7ae8fd30.js"><link rel="prefetch" href="/assets/js/59.3d7d7dea.js"><link rel="prefetch" href="/assets/js/6.993d7ad0.js"><link rel="prefetch" href="/assets/js/60.67ba2844.js"><link rel="prefetch" href="/assets/js/61.6c5542cd.js"><link rel="prefetch" href="/assets/js/62.a235dad7.js"><link rel="prefetch" href="/assets/js/63.a3a52fe2.js"><link rel="prefetch" href="/assets/js/64.2b6b610e.js"><link rel="prefetch" href="/assets/js/65.8672534a.js"><link rel="prefetch" href="/assets/js/66.c7281353.js"><link rel="prefetch" href="/assets/js/67.e062f6ac.js"><link rel="prefetch" href="/assets/js/68.446f0688.js"><link rel="prefetch" href="/assets/js/69.f03843ed.js"><link rel="prefetch" href="/assets/js/7.afb33a4c.js"><link rel="prefetch" href="/assets/js/70.466d842a.js"><link rel="prefetch" href="/assets/js/71.87fcb26b.js"><link rel="prefetch" href="/assets/js/72.ccf1092d.js"><link rel="prefetch" href="/assets/js/73.3ad6124b.js"><link rel="prefetch" href="/assets/js/74.17a59372.js"><link rel="prefetch" href="/assets/js/75.6c859470.js"><link rel="prefetch" href="/assets/js/76.674a56ad.js"><link rel="prefetch" href="/assets/js/77.5342f3c1.js"><link rel="prefetch" href="/assets/js/78.154ba5e1.js"><link rel="prefetch" href="/assets/js/79.10901b1c.js"><link rel="prefetch" href="/assets/js/8.5bbd7ae9.js"><link rel="prefetch" href="/assets/js/80.0166104e.js"><link rel="prefetch" href="/assets/js/81.4c5a0e6a.js"><link rel="prefetch" href="/assets/js/82.47099701.js"><link rel="prefetch" href="/assets/js/83.7873cd95.js"><link rel="prefetch" href="/assets/js/84.23000f66.js"><link rel="prefetch" href="/assets/js/85.6701c9e4.js"><link rel="prefetch" href="/assets/js/86.188012c3.js"><link rel="prefetch" href="/assets/js/87.e9cde64e.js"><link rel="prefetch" href="/assets/js/88.5ccdea49.js"><link rel="prefetch" href="/assets/js/89.9ab559de.js"><link rel="prefetch" href="/assets/js/9.6699859e.js"><link rel="prefetch" href="/assets/js/90.bc7fb61d.js"><link rel="prefetch" href="/assets/js/91.07537d0a.js"><link rel="prefetch" href="/assets/js/92.b4ed0bad.js"><link rel="prefetch" href="/assets/js/93.b167c2d0.js"><link rel="prefetch" href="/assets/js/94.1a02653c.js"><link rel="prefetch" href="/assets/js/95.69ef19be.js"><link rel="prefetch" href="/assets/js/96.e0b3f5df.js"><link rel="prefetch" href="/assets/js/97.9ea0c268.js"><link rel="prefetch" href="/assets/js/98.074852d9.js"><link rel="prefetch" href="/assets/js/99.708b118b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c9ffc21e.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="一盏烛光的微笑灿烂人生" class="logo"> <span class="site-name can-hide">一盏烛光的微笑灿烂人生</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="科研学习" class="dropdown-title"><a href="/study/" class="link-title">科研学习</a> <span class="title" style="display:none;">科研学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/articles/" class="nav-link">阅读记录</a></li><li class="dropdown-item"><!----> <a href="/biotech/" class="nav-link">生信分析</a></li><li class="dropdown-item"><!----> <a href="/basic/" class="nav-link">整理归纳</a></li></ul></div></div><div class="nav-item"><a href="/wlyh/" class="nav-link">围炉夜话</a></div><div class="nav-item"><a href="/technology/" class="nav-link">奇淫巧计</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li><li class="dropdown-item"><!----> <a href="/links/" class="nav-link">一些网站</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li><li class="dropdown-item"><!----> <a href="/passbyworld/" class="nav-link">路过人间</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://pica.zhimg.com/v2-f2b30ad5674f652294f0ec6f9b8c9922_720w.webp?source=d16d100b"> <div class="blogger-info"><h3>围炉夜话</h3> <span>知行合一</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="科研学习" class="dropdown-title"><a href="/study/" class="link-title">科研学习</a> <span class="title" style="display:none;">科研学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/articles/" class="nav-link">阅读记录</a></li><li class="dropdown-item"><!----> <a href="/biotech/" class="nav-link">生信分析</a></li><li class="dropdown-item"><!----> <a href="/basic/" class="nav-link">整理归纳</a></li></ul></div></div><div class="nav-item"><a href="/wlyh/" class="nav-link">围炉夜话</a></div><div class="nav-item"><a href="/technology/" class="nav-link">奇淫巧计</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li><li class="dropdown-item"><!----> <a href="/links/" class="nav-link">一些网站</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li><li class="dropdown-item"><!----> <a href="/passbyworld/" class="nav-link">路过人间</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>阅读记录</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>生信分析</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/9fc671/" class="sidebar-link">生信分析</a></li><li><a href="/pages/902bc2/" class="sidebar-link">转录组</a></li><li><a href="/pages/aebaf3/" class="sidebar-link">表观组</a></li><li><a href="/pages/819cd3/" class="sidebar-link">单细胞-概览</a></li><li><a href="/pages/c81394/" class="sidebar-link">单细胞-ATAC</a></li><li><a href="/pages/9033c2/" class="sidebar-link">单细胞-细胞注释</a></li><li><a href="/pages/e0b862/" class="sidebar-link">单细胞-异质性</a></li><li><a href="/pages/1cd666/" class="sidebar-link">Linux</a></li><li><a href="/pages/a8bb10/" class="sidebar-link">R</a></li><li><a href="/pages/d630fc/" class="sidebar-link">python</a></li><li><a href="/pages/73836e/" class="sidebar-link">基因注释</a></li><li><a href="/pages/49f65b/" class="sidebar-link">富集分析</a></li><li><a href="/pages/61f7f0/" class="sidebar-link">临床相关性</a></li><li><a href="/pages/28c669/" class="sidebar-link">WGCNA</a></li><li><a href="/pages/69a308/" aria-current="page" class="active sidebar-link">Seurat</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/69a308/#seurat" class="sidebar-link">Seurat</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/69a308/#标准处理流程" class="sidebar-link">标准处理流程：</a></li><li class="sidebar-sub-header level3"><a href="/pages/69a308/#标记基因的可视化" class="sidebar-link">标记基因的可视化</a></li><li class="sidebar-sub-header level3"><a href="/pages/69a308/#细分亚群" class="sidebar-link">细分亚群</a></li><li class="sidebar-sub-header level3"><a href="/pages/69a308/#增加meta信息" class="sidebar-link">增加meta信息</a></li><li class="sidebar-sub-header level3"><a href="/pages/69a308/#seurat中的结构" class="sidebar-link">Seurat中的结构</a></li><li class="sidebar-sub-header level3"><a href="/pages/69a308/#sctransform" class="sidebar-link">SCTransform</a></li><li class="sidebar-sub-header level3"><a href="/pages/69a308/#不常见" class="sidebar-link">不常见</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/69a308/#去除批次" class="sidebar-link">去除批次</a></li><li class="sidebar-sub-header level2"><a href="/pages/69a308/#关于harmony" class="sidebar-link">关于Harmony</a></li><li class="sidebar-sub-header level2"><a href="/pages/69a308/#免疫细胞注释" class="sidebar-link">免疫细胞注释</a></li><li class="sidebar-sub-header level2"><a href="/pages/69a308/#聚类" class="sidebar-link">聚类</a></li></ul></li><li><a href="/pages/784c69/" class="sidebar-link">Scanpy</a></li><li><a href="/pages/44ad24/" class="sidebar-link">Monocle2</a></li><li><a href="/pages/893dcf/" class="sidebar-link">单细胞-轨迹分析</a></li><li><a href="/pages/7989c6/" class="sidebar-link">CellPhoneDB</a></li><li><a href="/pages/dbe3de/" class="sidebar-link">CellChat2</a></li><li><a href="/pages/df4df8/" class="sidebar-link">NicheNet</a></li><li><a href="/pages/5f4d84/" class="sidebar-link">SCENIC</a></li><li><a href="/pages/9f91d0/" class="sidebar-link">单细胞-RNA velocity</a></li><li><a href="/pages/d079f5/" class="sidebar-link">细胞外囊泡</a></li><li><a href="/pages/d7b340/" class="sidebar-link">数据分析和数据挖掘</a></li><li><a href="/pages/c7d198/" class="sidebar-link">数据处理</a></li><li><a href="/pages/e50bac/" class="sidebar-link">data.frame</a></li><li><a href="/pages/500bc4/" class="sidebar-link">ggplot2</a></li><li><a href="/pages/937699/" class="sidebar-link">数据可视化-Python</a></li><li><a href="/pages/6cbee5/" class="sidebar-link">绘图</a></li><li><a href="/pages/5666ad/" class="sidebar-link">统计</a></li><li><a href="/pages/e75428/" class="sidebar-link">想法和借鉴</a></li><li><a href="/pages/7f8ebe/" class="sidebar-link">Algorithm</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>实验技术</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>整理归纳</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/study/#科研学习" data-v-06225672>科研学习</a></li><li data-v-06225672><a href="/study/#生信分析" data-v-06225672>生信分析</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>FHL</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-12-01</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Seurat<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="seurat"><a href="#seurat" class="header-anchor">#</a> Seurat</h2> <p>Seurat 3+ 补充了这个函数 —— SCTransform() = NormalizeData() + ScaleData() + FindVariableFeatures()</p> <blockquote><p>对测序深度的矫正效果好于log标准化（10w以内的细胞建议使用SCT标准化）；也可以用于矫正线粒体等因素影响，但不可以用于批次矫正</p></blockquote> <p>NormalizeData() + ScaleData() + FindVariableFeatures()后的数据：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>seurat_obj--assays--
	RNA
		counts：原始矩阵
		data：
			normalize（log）后的矩阵, 
			scale.data: scale后的矩阵, 
			var.features: 找出的2000个variable features
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>SCTransform()后的数据：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>seurat_obj--assays--
	RNA--仍然保留
	SCT：
		counts：原始矩阵
		data：
			标准后的数据,
			scale.data: 缩放后的数据, 
			var.features: 高度变化的特征
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>存放于不同的slot（RNA，SCT这一级），输入PCs越多，能找到更多的生物学差异var.features（特征基因），也会引入更多的技术误差，SCT找了更多的var.features</p> <h3 id="标准处理流程"><a href="#标准处理流程" class="header-anchor">#</a> 标准处理流程：</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code># 数据来源 
# https://cf.10xgenomics.com/samples/cell/pbmc3k/pbmc3k_filtered_gene_bc_matrices.tar.gz  


library(Seurat)  
library(SeuratData)  
library(ggplot2)  
library(patchwork)  
library(dplyr)  


pbmc.data &lt;- Read10X(data.dir = &quot;filtered_gene_bc_matrices/hg19/&quot;)   
pbmc &lt;- CreateSeuratObject(counts = pbmc.data, project = &quot;pbmc3k&quot;, min.cells = 3, min.features = 200)  

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>&gt;pbmc  
An object of class Seurat   
13714 features across 2700 samples within 1 assay   
Active assay: RNA (13714 features, 0 variable features)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>pbmc[[&quot;percent.mt&quot;]] &lt;- PercentageFeatureSet(pbmc, pattern = &quot;^MT-&quot;)   # 计算线粒体比例，基因名中，人类线粒体基因以MT开头，小鼠以mt开头

#Visualize QC metrics as a violin plot  
VlnPlot(pbmc, features = c(&quot;nFeature_RNA&quot;, &quot;nCount_RNA&quot;, &quot;percent.mt&quot;), ncol = 3)  

# FeatureScatter is typically used to visualize feature-feature relationships, 
# but can be used for anything calculated by the object, i.e. columns in object metadata, PC scores etc.  
plot1 &lt;- FeatureScatter(pbmc, feature1 = &quot;nCount_RNA&quot;, feature2 = &quot;percent.mt&quot;)   
plot2 &lt;- FeatureScatter(pbmc, feature1 = &quot;nCount_RNA&quot;, feature2 = &quot;nFeature_RNA&quot;)   
plot1 + plot2  

pbmc &lt;- subset(pbmc, subset = nFeature_RNA &gt; 200 &amp; nFeature_RNA &lt; 2500 &amp; percent.mt &lt; 5)  
pbmc &lt;- NormalizeData(pbmc, normalization.method = &quot;LogNormalize&quot;, scale.factor = 1e4)   
pbmc &lt;- FindVariableFeatures(pbmc, selection.method = 'vst', nfeatures = 2000)  

# Identify the 10 most highly variable genes  
top10 &lt;- head(VariableFeatures(pbmc), 10)  

# plot variable features with and without labels  
plot1 &lt;- VariableFeaturePlot(pbmc)  
plot2 &lt;- LabelPoints(plot = plot1, points = top10, repel = TRUE)  
plot1 + plot2  
pbmc &lt;- ScaleData(pbmc, vars.to.regress = &quot;percent.mt&quot;)  
pbmc &lt;- RunPCA(pbmc, features = VariableFeatures(object = pbmc))    

pbmc &lt;- FindNeighbors(pbmc, dims = 1:10)  
pbmc &lt;- FindClusters(pbmc, resolution = 0.5)  

# Look at cluster IDs of the first 5 cells  
head(Idents(pbmc), 5)  
table(pbmc$seurat_clusters)   
pbmc &lt;- RunUMAP(pbmc, dims = 1:10)  

# note that you can set `label = TRUE` or use the LabelClusters function to help label individual clusters  
DimPlot(pbmc, reduction = 'umap')  
VlnPlot(pbmc, features = c(&quot;MS4A1&quot;, &quot;CD79A&quot;))   
FeaturePlot(pbmc, features = c(&quot;MS4A1&quot;, &quot;GNLY&quot;, &quot;CD3E&quot;, &quot;CD14&quot;, &quot;FCER1A&quot;, &quot;FCGR3A&quot;, &quot;LYZ&quot;, &quot;PPBP&quot;, &quot;CD8A&quot;))  


# 注释命名部分
new.cluster.ids &lt;- c(&quot;Naive CD4 T&quot;, &quot;CD14+ Mono&quot;, &quot;Memory CD4 T&quot;, &quot;B&quot;, &quot;CD8 T&quot;, &quot;FCGR3A+ Mono&quot;, &quot;NK&quot;, &quot;DC&quot;, &quot;Platelet&quot;)  
names(new.cluster.ids) &lt;- levels(pbmc)  
pbmc &lt;- RenameIdents(pbmc, new.cluster.ids)  
DimPlot(pbmc, reduction = 'umap', label = TRUE, pt.size = 0.5) + NoLegend()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>&gt; pbmc  
An object of class Seurat   
13714 features across 2638 samples within 1 assay   
Active assay: RNA (13714 features, 2000 variable features)  
2 dimensional reductions calculated: pca, umap
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="标记基因的可视化"><a href="#标记基因的可视化" class="header-anchor">#</a> 标记基因的可视化</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code># 小提琴图
VlnPlot(pbmc, features = c(&quot;MS4A1&quot;, &quot;CD79A&quot;))  

# 坐标映射图
FeaturePlot(pbmc, features = c(&quot;MS4A1&quot;, &quot;CD79A&quot;))  

# 峰峦图
RidgePlot(pbmc, features = c(&quot;MS4A1&quot;, &quot;CD79A&quot;), ncol = 1)  

# 气泡图
features= c('IL7R', 'CCR7','CD14', 'LYZ',  'IL7R', 'S100A4',&quot;MS4A1&quot;, &quot;CD8A&quot;, 'FCGR3A', 'MS4A7', 'GNLY', 'NKG7','FCER1A', 'CST3','PPBP')  

DotPlot(pbmc, features = unique(features)) + RotatedAxis() + coord_flip()

# 热图
DoHeatmap(subset(pbmc, downsample = 100), features = features, size = 3)

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>怎么改名字呢？</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>new_cluster_ids &lt;- c('T cell','B cell') # 按照levels(pbmc)的顺序排列
names(new_cluster_ids) &lt;- levels(mergeHarmony)
mergeHarmony &lt;- RenameIdents(mergeHarmony, new_cluster_ids)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>celltype = data.frame(ClusterID = 0:34, celltype='unkown')
celltype[celltype$ClusterID %in% c(31),2]='T cells' 
celltype[celltype$ClusterID %in% c(24,32),2]='B cells'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="细分亚群"><a href="#细分亚群" class="header-anchor">#</a> 细分亚群</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code># 下面的 TP53 &gt; 10 仅仅是举例方便

highCells &lt;- colnames(subset(x = sce, subset = TP53 &gt; 10, slot = 'counts'))

highORlow &lt;- ifelse(colnames(sce) %in% highCells,'high','low')

table(highORlow)

sce@meta.data$highORlow=highORlow

markers &lt;- FindMarkers(sce, ident.1 = &quot;high&quot;, 
                       group.by = 'highORlow', 
                       subset.ident = &quot;0&quot;)
head(x = markers)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="增加meta信息"><a href="#增加meta信息" class="header-anchor">#</a> 增加meta信息</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>pmbc &lt;- AddMetaData(object = pmbc,     #seurat对象
                    metadata = age,    #需要添加的metadata
                    col.name = &quot;age&quot;)  #给新添加的metadata命名

pbmc$metaname &lt;- NewmetaName


Idents(object = pbmc, cells = 1:10) &lt;- &quot;orig.ident&quot; #将前10个细胞ident设置为&quot;orig.ident&quot;
Idents(object = pbmc) &lt;- &quot;orig.ident&quot; #将&quot;orig.ident&quot;设置为pbmc的&quot;active.ident&quot;

pbmc &lt;- RenameIdents(object = pbmc, `CD4 T cells` = &quot;T Helper cells&quot;)


Embeddings(object = pbmc, reduction = &quot;pca&quot;) #检索每个细胞的PC矩阵
Loadings(object = pbmc, reduction = &quot;pca&quot;) #检索每个基因的PC矩阵



# FetchData可以从expression matrices, cell embeddings或metadata中取出任何值
head(FetchData(object = pbmc, vars = c(&quot;PC_1&quot;, &quot;percent.mt&quot;, &quot;MS4A1&quot;)))
#                        PC_1 percent.mt    MS4A1
# AAACATACAACCAC-1 -4.7296855  3.0177759 0.000000
# AAACATTGAGCTAC-1 -0.5174029  3.7935958 2.583047
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>Annotation = clustertable[match(as.numeric(as.character(seurat_data@active.ident)), clustertable[, 1]), 2]

`clustertable`是一个包含两个列的数据框，第一列是细胞标识符（active.ident），第二列是对应的标签（细胞类型）

这行代码首先从`seurat_data`对象中获取当前活动的细胞标识符（`active.ident`），然后将它们转换为数值型，以便与`clustertable`数据框（data frame）的第一列进行匹配。通过`match`函数找到匹配的行，然后从第二列获取对应的标签（`labers`）。
    
seurat_data$celltype &lt;- Annotation
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>还可以改变cluster的顺序 -- <a href="https://cloud.tencent.com/developer/article/1841517" target="_blank" rel="noopener noreferrer">对细胞簇重命名<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>数值变分类</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>age = as.numeric(pbmc@meta.data$age)

age[age &gt;= 6 &amp;amp; age &amp;lt; 12] &amp;lt;- 2
age[age == &quot;2&quot;] &amp;lt;- &quot;age 6-12&quot;

pbmc$agegroup &amp;lt;- age
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="seurat中的结构"><a href="#seurat中的结构" class="header-anchor">#</a> Seurat中的结构</h3> <p>levels &amp; Idents &amp; layer &amp; Assay</p> <p>Ident，身份，也可以理解为每个细胞状态或身份的标识符</p> <p>levels，层次，表示数据的层次结构</p> <p>Layer，数据层，不同的数据集</p> <p>Assay，矩阵，包括基因表达矩阵，免疫表型数据，表观组数据等等</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>levels(x = pbmc_small)
#&gt; [1] &quot;B&quot; &quot;A&quot; &quot;C&quot;
levels(x = pbmc_small) &lt;- c('C', 'A', 'B')


pbmc_small &lt;- RenameIdents(pbmc_small, '0' = 'A', '2' = 'C')
levels(pbmc_small)


identityMapping &lt;- c('0' = 'A', '2' = 'C')
pbmc_small &lt;- RenameIdents(pbmc_small, identityMapping )


cells.use &lt;- WhichCells(pbmc_small, idents = '1')
pbmc_small &lt;- SetIdent(pbmc_small, cells = cells.use, value = 'B')
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>Assay里面的数据</p> <ul><li>counts，dgCMatrix，未处理的原始稀疏矩阵</li> <li>data，dgCMatrix，标准化的稀疏矩阵（normalize）</li> <li>scale.data，matrix，缩放矩阵</li> <li>key，character，active对象的键，（fetch）</li> <li>var.features，character，高变基因（VaribleFeatures）</li> <li>meta.deatures，data.frame，对feature/（gene）的注释</li></ul> <p>meta.data；active.ident；reduction；version；commands</p> <h3 id="sctransform"><a href="#sctransform" class="header-anchor">#</a> SCTransform</h3> <h3 id="不常见"><a href="#不常见" class="header-anchor">#</a> 不常见</h3> <p>UpdateSeuratObject()</p> <h2 id="去除批次"><a href="#去除批次" class="header-anchor">#</a> 去除批次</h2> <p>单细胞常用的几种整合方法：CCA，SCTransform，Harmony</p> <p>CCA，Seurat2自带，比较慢，循环着找<code>锚点</code>，再整合；推荐reference-based</p> <blockquote><p>CCA，Canonical Correlation Analysis，典型关联分析</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>PercentageFeatureSet() → subset() → FindVariableFeatures() →  ormalizeData() → FindVariableFeatures()

FindIntegrationAnchors()
IntegrateData()

ScaleData() → RunPCA() → RunTSNE() → RunUMAP() → FindNeighbors() → FindClusters()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>SCTransform，先SCTransform处理，再找锚点，整合</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PercentageFeatureSet() → subset() → NormalizeData()

SelectIntegrationFeatures()
PrepSCTIntegration()
FindIntegrationAnchors()
IntegrateData()

RunPCA() → RunTSNE() → RunUMAP() → FindNeighbors() → FindClusters()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Harmony，稍快些</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PercentageFeatureSet() → subset() → FindVariableFeatures() → NormalizeData() → FindVariableFeatures() → ScaleData() → RunPCA() → 

RunHarmony()

RunTSNE() → RunUMAP() → FindNeighbors() → FindClusters()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>DefaultAssay(pbmc) &lt;- 'RNA'</p> <p>整合应该按照个体，或者样本编号进行，而不是按照正常与肿瘤整合</p> <p>CCA，Canonical Correlation Analysis，典型关联分析，Seurat2使用；</p> <p>CCA + MNN，Mutual Nearest Neighbor，互相最近邻居，Seurat3，4使用</p> <p>一段很不错的代码</p> <p><strong>读取和质控</strong></p> <div class="language-R line-numbers-mode"><pre class="language-r"><code>
library<span class="token punctuation">(</span>Seurat<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>harmony<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>tidyverse<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>patchwork<span class="token punctuation">)</span>
rm<span class="token punctuation">(</span>list <span class="token operator">=</span> ls<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


scRNAlist <span class="token operator">&lt;-</span> list<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">:</span>length<span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  counts <span class="token operator">&lt;-</span> Read10X<span class="token punctuation">(</span>data.dir <span class="token operator">=</span> dir<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> 
  scRNAlist<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> CreateSeuratObject<span class="token punctuation">(</span>counts<span class="token punctuation">,</span> project<span class="token operator">=</span>samples_name<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                       min.cells<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> min.features <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">)</span>
  <span class="token comment">#给细胞barcode加个前缀，防止合并后barcode重名</span>
  scRNAlist<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> RenameCells<span class="token punctuation">(</span>scRNAlist<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> add.cell.id <span class="token operator">=</span> samples_name<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>   
  <span class="token comment">#计算线粒体基因比例</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">{</span>    
    scRNAlist<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;percent.mt&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> PercentageFeatureSet<span class="token punctuation">(</span>scRNAlist<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pattern <span class="token operator">=</span> <span class="token string">&quot;^MT-&quot;</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span>
  <span class="token comment">#计算核糖体基因比例</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">{</span>
    scRNAlist<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;percent.rb&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;-</span> PercentageFeatureSet<span class="token punctuation">(</span>scRNAlist<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pattern <span class="token operator">=</span> <span class="token string">&quot;^RP[SL]&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">#计算红细胞基因比例</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">{</span>
    HB.genes <span class="token operator">&lt;-</span> c<span class="token punctuation">(</span><span class="token string">&quot;HBA1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;HBA2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;HBB&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;HBD&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;HBE1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;HBG1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;HBG2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;HBM&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;HBQ1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;HBZ&quot;</span><span class="token punctuation">)</span>
    HB.genes <span class="token operator">&lt;-</span> CaseMatch<span class="token punctuation">(</span>HB.genes<span class="token punctuation">,</span> rownames<span class="token punctuation">(</span>scRNAlist<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    scRNAlist<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;percent.HB&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">&lt;-</span>PercentageFeatureSet<span class="token punctuation">(</span>scRNAlist<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> features<span class="token operator">=</span>HB.genes<span class="token punctuation">)</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


names<span class="token punctuation">(</span>scRNAlist<span class="token punctuation">)</span> <span class="token operator">&lt;-</span> samples_name
system.time<span class="token punctuation">(</span>saveRDS<span class="token punctuation">(</span>scRNAlist<span class="token punctuation">,</span> file <span class="token operator">=</span> <span class="token string">&quot;scRNAlist.rds&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p><strong>查看指控效果</strong> -- 特别是这段</p> <div class="language-R line-numbers-mode"><pre class="language-r"><code>scRNA <span class="token operator">&lt;-</span> merge<span class="token punctuation">(</span>scRNAlist<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> scRNAlist<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">:</span>length<span class="token punctuation">(</span>scRNAlist<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
table<span class="token punctuation">(</span>scRNA<span class="token operator">$</span>orig.ident<span class="token punctuation">)</span>
<span class="token comment">### 绘制质控小提琴图</span>

theme.set2 <span class="token operator">=</span> theme<span class="token punctuation">(</span>axis.title.x<span class="token operator">=</span>element_blank<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 设置可能用到的主题</span>
plot.featrures <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">&quot;nFeature_RNA&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;nCount_RNA&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;percent.mt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;percent.rb&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;percent.HB&quot;</span><span class="token punctuation">)</span> <span class="token comment"># 设置绘图元素</span>
group <span class="token operator">=</span> <span class="token string">&quot;orig.ident&quot;</span>
<span class="token comment"># 质控前小提琴图</span>
plots <span class="token operator">=</span> list<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">in</span> seq_along<span class="token punctuation">(</span>plot.featrures<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  plots<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> VlnPlot<span class="token punctuation">(</span>scRNA<span class="token punctuation">,</span> group.by<span class="token operator">=</span>group<span class="token punctuation">,</span> pt.size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
                       features <span class="token operator">=</span> plot.featrures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> theme.set2 <span class="token operator">+</span> NoLegend<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
violin <span class="token operator">&lt;-</span> wrap_plots<span class="token punctuation">(</span>plots <span class="token operator">=</span> plots<span class="token punctuation">,</span> nrow<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>    
ggsave<span class="token punctuation">(</span><span class="token string">&quot;vlnplot_before_qc.pdf&quot;</span><span class="token punctuation">,</span> plot <span class="token operator">=</span> violin<span class="token punctuation">,</span> width <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">,</span> height <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span>



<span class="token comment">### 设置质控标准</span>
minGene<span class="token operator">=</span><span class="token number">500</span>
maxGene<span class="token operator">=</span><span class="token number">4000</span>
maxUMI<span class="token operator">=</span><span class="token number">15000</span>
pctMT<span class="token operator">=</span><span class="token number">10</span>
pctHB<span class="token operator">=</span><span class="token number">1</span>

<span class="token comment">### 数据质控并绘制小提琴图</span>
scRNA <span class="token operator">&lt;-</span> subset<span class="token punctuation">(</span>scRNA<span class="token punctuation">,</span> subset <span class="token operator">=</span> nCount_RNA <span class="token operator">&lt;</span> maxUMI <span class="token operator">&amp;</span> nFeature_RNA <span class="token operator">&gt;</span> minGene <span class="token operator">&amp;</span> 
                  nFeature_RNA <span class="token operator">&lt;</span> maxGene <span class="token operator">&amp;</span> percent.mt <span class="token operator">&lt;</span> pctMT <span class="token operator">&amp;</span> percent.HB <span class="token operator">&lt;</span> pctHB<span class="token punctuation">)</span>
plots <span class="token operator">=</span> list<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">in</span> seq_along<span class="token punctuation">(</span>plot.featrures<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  plots<span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> VlnPlot<span class="token punctuation">(</span>scRNA<span class="token punctuation">,</span> group.by<span class="token operator">=</span>group<span class="token punctuation">,</span> pt.size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
                       features <span class="token operator">=</span> plot.featrures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> theme.set2 <span class="token operator">+</span> NoLegend<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
violin <span class="token operator">&lt;-</span> wrap_plots<span class="token punctuation">(</span>plots <span class="token operator">=</span> plots<span class="token punctuation">,</span> nrow<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>     
ggsave<span class="token punctuation">(</span><span class="token string">&quot;QC/vlnplot_after_qc.pdf&quot;</span><span class="token punctuation">,</span> plot <span class="token operator">=</span> violin<span class="token punctuation">,</span> width <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> height <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p><img src="https://upload-images.jianshu.io/upload_images/15771939-3c11e4ac277fc2a0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="质控前的图"></p> <p><img src="https://upload-images.jianshu.io/upload_images/15771939-d290cb12412bcf2f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="质控后的图"></p> <p><strong>降维聚类</strong> -- 这段代码也很酷</p> <div class="language-R line-numbers-mode"><pre class="language-r"><code>scRNA <span class="token operator">&lt;-</span> NormalizeData<span class="token punctuation">(</span>scRNA<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> FindVariableFeatures<span class="token punctuation">(</span>nfeatures <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> ScaleData<span class="token punctuation">(</span><span class="token punctuation">)</span>
scRNA <span class="token operator">&lt;-</span> RunPCA<span class="token punctuation">(</span>scRNA<span class="token punctuation">,</span> verbose <span class="token operator">=</span> F<span class="token punctuation">)</span>
ElbowPlot<span class="token punctuation">(</span>scRNA<span class="token punctuation">,</span> ndims <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>Seurat 锚点整合</strong></p> <div class="language-R line-numbers-mode"><pre class="language-r"><code><span class="token comment"># 1、读入数据，拆分样本</span>
rm<span class="token punctuation">(</span>list<span class="token operator">=</span>ls<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
library<span class="token punctuation">(</span>future<span class="token punctuation">)</span> <span class="token comment">#Seurat并行计算的一个包</span>
options<span class="token punctuation">(</span>future.globals.maxSize <span class="token operator">=</span> <span class="token number">50</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token operator">^</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">#将全局变量上限调至50G（锚点整合很占内存）</span>

<span class="token comment">## 重新创建没有处理的经过降维等处理的数据 </span>
scRNA <span class="token operator">&lt;-</span> readRDS<span class="token punctuation">(</span><span class="token string">&quot;scRNA.rds&quot;</span><span class="token punctuation">)</span>
cellinfo <span class="token operator">&lt;-</span> subset<span class="token punctuation">(</span>scRNA<span class="token operator">@</span>meta.data<span class="token punctuation">,</span> select <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">&quot;orig.ident&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;percent.mt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;percent.rb&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;percent.HB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
scRNA <span class="token operator">&lt;-</span> CreateSeuratObject<span class="token punctuation">(</span>scRNA<span class="token operator">@</span>assays<span class="token operator">$</span>RNA<span class="token operator">@</span>counts<span class="token punctuation">,</span> meta.data <span class="token operator">=</span> cellinfo<span class="token punctuation">)</span>
<span class="token comment">#做锚点整合需要把样本处理成单个的Seurat对象来两两组合；也可以按别的指标（metadata中的）来进行拆分，比如可以按不同的分组来拆分样本，再进行整合。</span>
scRNAlist <span class="token operator">&lt;-</span> SplitObject<span class="token punctuation">(</span>scRNA<span class="token punctuation">,</span> split.by <span class="token operator">=</span> <span class="token string">&quot;orig.ident&quot;</span><span class="token punctuation">)</span>


<span class="token comment"># 2、标准化（锚点整合会把单个样本两两组合，所以需要单独做标准化—</span>

<span class="token comment">#SCTransform标准化(⚠️使用log标准化还是SCT标准化差别不大)</span>
<span class="token comment">#如果用log标准化，后面FindIntegrationAnchors和IntegrateData函数的normalization.method参数选'LogNormalize'</span>
<span class="token comment">#10个对象最好写10个核，没有10个核少写几个也可以。top命令可以查看服务器有几个核，mc.core设置为1就每次处理一个对象。</span>
<span class="token comment"># mclapply是lapply的多核版本</span>
scRNAlist <span class="token operator">&lt;-</span> parallel<span class="token operator">::</span>mclapply<span class="token punctuation">(</span>scRNAlist<span class="token punctuation">,</span> FUN<span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> SCTransform<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> mc.cores <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span> 

								
<span class="token number">3</span>、选择用于整合的高变基因
								
<span class="token comment">### 每个样本的高变基因不完全一样，SelectIntegrationFeatures可以整合这些高变基因，选出3000个</span>
scRNA.features <span class="token operator">&lt;-</span> SelectIntegrationFeatures<span class="token punctuation">(</span>scRNAlist<span class="token punctuation">,</span> nfeatures <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">)</span> 
scRNAlist <span class="token operator">&lt;-</span> PrepSCTIntegration<span class="token punctuation">(</span>scRNAlist<span class="token punctuation">,</span> anchor.features <span class="token operator">=</span> scRNA.features<span class="token punctuation">)</span> 

plan<span class="token punctuation">(</span><span class="token string">&quot;multisession&quot;</span><span class="token punctuation">,</span> workers <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
scRNA.anchors <span class="token operator">&lt;-</span> FindIntegrationAnchors<span class="token punctuation">(</span>object.list <span class="token operator">=</span> scRNAlist<span class="token punctuation">,</span>       <span class="token comment">#寻找锚点，运行速度非常慢，至少需要1-2小时</span>
                                        normalization.method <span class="token operator">=</span> <span class="token string">&quot;SCT&quot;</span><span class="token punctuation">,</span>  <span class="token comment">#如果前面是log标准化，这里改成LogNormalize</span>
                                        anchor.features <span class="token operator">=</span> scRNA.features<span class="token punctuation">)</span>

<span class="token number">4</span>、整合锚点
<span class="token comment"># 速度也很慢</span>
plan<span class="token punctuation">(</span><span class="token string">&quot;sequential&quot;</span><span class="token punctuation">)</span> <span class="token comment">#把并行计算改为单核计算</span>
scRNA.sct.int <span class="token operator">&lt;-</span> IntegrateData<span class="token punctuation">(</span>scRNA.anchors<span class="token punctuation">,</span> normalization.method<span class="token operator">=</span><span class="token string">&quot;SCT&quot;</span><span class="token punctuation">)</span> <span class="token comment">#速度慢</span>


<span class="token number">5</span>、降维和可视化
<span class="token comment">### redunction</span>
scRNA <span class="token operator">&lt;-</span> RunPCA<span class="token punctuation">(</span>scRNA.sct.int<span class="token punctuation">,</span> npcs <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">,</span> verbose <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
ElbowPlot<span class="token punctuation">(</span>scRNA<span class="token punctuation">,</span> ndims<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>
pc.num<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">20</span>
scRNA <span class="token operator">&lt;-</span> scRNA <span class="token percent-operator operator">%&gt;%</span> RunTSNE<span class="token punctuation">(</span>dims<span class="token operator">=</span>pc.num<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> RunUMAP<span class="token punctuation">(</span>dims<span class="token operator">=</span>pc.num<span class="token punctuation">)</span>

<span class="token comment">### Visual</span>
p <span class="token operator">&lt;-</span> DimPlot<span class="token punctuation">(</span>scRNA<span class="token punctuation">,</span> group.by <span class="token operator">=</span> <span class="token string">&quot;orig.ident&quot;</span><span class="token punctuation">)</span>
ggsave<span class="token punctuation">(</span><span class="token string">&quot;UMAP_Samples_integr.pdf&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> width <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span> height <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">)</span>
p <span class="token operator">&lt;-</span> DimPlot<span class="token punctuation">(</span>scRNA<span class="token punctuation">,</span> group.by <span class="token operator">=</span> <span class="token string">&quot;orig.ident&quot;</span><span class="token punctuation">,</span> split.by <span class="token operator">=</span> <span class="token string">&quot;orig.ident&quot;</span><span class="token punctuation">,</span> ncol <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span>
ggsave<span class="token punctuation">(</span><span class="token string">&quot;UMAP_Samples_Split_integr.pdf&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> width <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">,</span> height <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">)</span>

<span class="token number">6</span>、结果评估
scRNA <span class="token operator">&lt;-</span> FindNeighbors<span class="token punctuation">(</span>scRNA<span class="token punctuation">,</span> dims <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> FindClusters<span class="token punctuation">(</span><span class="token punctuation">)</span>
load<span class="token punctuation">(</span><span class="token string">&quot;ref_Hematopoietic.RData&quot;</span><span class="token punctuation">)</span>
DefaultAssay<span class="token punctuation">(</span>scRNA<span class="token punctuation">)</span> <span class="token operator">&lt;-</span> <span class="token string">&quot;RNA&quot;</span>
scRNA <span class="token operator">&lt;-</span> cell_identify<span class="token punctuation">(</span>scRNA<span class="token punctuation">,</span> ref_Hematopoietic<span class="token punctuation">)</span> <span class="token comment">#cell_identify是自己写的函数，ref_Hematopoietic是SingleR中的参考数据集</span>
p <span class="token operator">&lt;-</span> DimPlot<span class="token punctuation">(</span>scRNA<span class="token punctuation">,</span> group.by <span class="token operator">=</span> <span class="token string">&quot;SingleR&quot;</span><span class="token punctuation">,</span> label <span class="token operator">=</span> T<span class="token punctuation">)</span>
ggsave<span class="token punctuation">(</span><span class="token string">&quot;SingleR_Seurat.pdf&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> width <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span> height <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>

Harmony整合
```R
1、准备数据
rm(list = ls())
scRNA &lt;- readRDS(&quot;scRNA.rds&quot;)
cellinfo &lt;- subset(scRNA@meta.data, select = c(&quot;orig.ident&quot;, &quot;percent.mt&quot;, &quot;percent.rb&quot;, &quot;percent.HB&quot;))
scRNA &lt;- CreateSeuratObject(scRNA@assays$RNA@counts, meta.data = cellinfo)

2、数据标准化（和锚点整合不同，不需拆分样本，直接标准化）
scRNA &lt;- SCTransform(scRNA) # SCT标准化数据
scRNA &lt;- RunPCA(scRNA, npcs=50, verbose=FALSE) # PCA

3、整合
# 整合方法1：单个样本间进行整合（推荐，效果更好）
# group.by.vars, 设置按哪个分组来整合
# max.iter.harmony设置迭代次数, 默认是10。运行RunHarmony结果会提示在迭代多少次后完成了收敛。
#⚠️RunHarmony函数中, lambda参数，默认值是1，决定了Harmony整合的力度。lambda值调小，整合力度变大，反之。（只有这个参数影响整合力度，调整范围一般在0.5-2之间）
scRNA &lt;- RunHarmony(scRNA, group.by.vars=&quot;orig.ident&quot;, assay.use=&quot;SCT&quot;, max.iter.harmony = 20) 


# 整合方法2：按其他分类，如不同分组来校正（实测效果不如方法1）
if(F){
  scRNA$batches &lt;- scRNA$orig.ident
  scRNA$batches &lt;- recode(scRNA$batches, 
                          &quot;HNC01PBMC&quot; = &quot;batch1&quot;, 
                          &quot;HNC01TIL&quot; = &quot;batch2&quot;,
                          &quot;HNC10PBMC&quot; = &quot;batch1&quot;,
                          &quot;HNC10TIL&quot; = &quot;batch2&quot;,
                          &quot;HNC20PBMC&quot; = &quot;batch1&quot;,
                          &quot;HNC20TIL&quot; = &quot;batch2&quot;,
                          &quot;PBMC1&quot; = &quot;batch1&quot;,
                          &quot;PBMC2&quot; = &quot;batch1&quot;,
                          &quot;Tonsil1&quot; = &quot;batch3&quot;,
                          &quot;Tonsil2&quot; = &quot;batch3&quot;)
  scRNA2 &lt;- RunHarmony(scRNA, group.by.vars=&quot;batches&quot;, assay.use=&quot;SCT&quot;)
}

4、降维聚类
ElbowPlot(scRNA, ndims = 50)
pc.num=1:30
scRNA &lt;- RunTSNE(scRNA, reduction=&quot;harmony&quot;, dims=pc.num) %&gt;% RunUMAP(reduction=&quot;harmony&quot;, dims=pc.num)
#scRNA2 &lt;- RunTSNE(scRNA2, reduction=&quot;harmony&quot;, dims=pc.num) %&gt;% RunUMAP(reduction=&quot;harmony&quot;, dims=pc.num)

p &lt;- DimPlot(scRNA, group.by = &quot;orig.ident&quot;) ggsave(&quot;UMAP_Samples_harmony.pdf&quot;, p, width = 8, height = 6)
p &lt;- DimPlot(scRNA, group.by = &quot;orig.ident&quot;, split.by = &quot;orig.ident&quot;, ncol = 4)
ggsave(&quot;UMAP_Samples_Split_harmony.pdf&quot;, p, width = 18, height = 12)

5、评估整合结果
scRNA &lt;- FindNeighbors(scRNA, dims = 1:30) %&gt;% FindClusters()
load(&quot;ref_Hematopoietic.RData&quot;)
scRNA &lt;- cell_identify(scRNA, ref_Hematopoietic)
p &lt;- DimPlot(scRNA, group.by = &quot;SingleR&quot;, label = T)
ggsave(&quot;SingleR_Harmony.pdf&quot;, p, width = 8, height = 6)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>左边是Harmony，右边是CCA方法 -- 锚点整合的有些过分，表达量几乎变成了一样的，没办法做后续的分析<br> <img src="https://upload-images.jianshu.io/upload_images/15771939-20fae0f2581d8ea1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1120/format/webp" alt="Harmony &amp; CCA方法 "></p> <h2 id="关于harmony"><a href="#关于harmony" class="header-anchor">#</a> 关于Harmony</h2> <p>Harmony输入的是<code>scRNA@reductions$pca</code>的数据，得出的结果储存在<code>scRNA@reductions$harmony</code>中</p> <p>许多下游分析是在低维嵌入而不是基因表达上进行的。要使用校正后的Harmony embeddings而不是PC，需要设置<code>reduction ='harmony'</code></p> <blockquote><p>下游分析，包括但不限于：RunUMAP，FindNeighBors，FindClusters</p></blockquote> <p>RunHarmony函数中主要参数</p> <ul><li><code>group.by.vars</code>，设置按哪个分组来整合</li> <li><code>max.iter.harmony</code>，设置迭代次数，默认是10。运行时会提示在迭代多少次后完成了收敛。</li> <li><code>lambda</code>，默认值是1，决定了Harmony整合的力度。lambda值调小，整合力度变大（只有这个参数影响整合力度，调整范围一般在0.5-2）</li> <li><code>theta</code>，Diversity clustering penalty parameter. Specify for each variable in group.by.vars. <strong>Default theta=2</strong>. theta=0 does not encourage any diversity. Larger values of theta result in more diverse clusters. 这个参数我常用默认值，但在不同文献中这个参数往往不同。</li> <li><code>dims.use</code>，Which PCA dimensions to use for Harmony. By default, use all.</li> <li><code>sigma</code>，Width of soft kmeans clusters. Default sigma=0.1. Sigma scales the distance from a cell to cluster centroids. Larger values of sigma result in cells assigned to more clusters. Smaller values of sigma make soft kmeans cluster approach hard clustering.</li></ul> <p>主要原理
<img src="https://upload-images.jianshu.io/upload_images/15771939-dce2141bd95d3013.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="Harmony主要原理"></p> <p>参考资料：</p> <p><a href="https://www.jianshu.com/p/acd2138fb449" target="_blank" rel="noopener noreferrer">Seurat的三种单细胞数据整合方法汇总（批次校正）-  简书<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.jianshu.com/p/159df5c4ff21" target="_blank" rel="noopener noreferrer">10x单细胞对象的合并和批次校正--seurat锚点整合+Harmony - 简书<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="免疫细胞注释"><a href="#免疫细胞注释" class="header-anchor">#</a> 免疫细胞注释</h2> <p><a href="https://mp.weixin.qq.com/s/0QIx7m5rQC5eD-0MGZSSnQ" target="_blank" rel="noopener noreferrer">公共数据库验证出来了就是对的吗 (qq.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>但细胞亚群的生物学命名的四个规则：</p> <ul><li>已知的生物学亚群</li> <li>顺序编码加上特异性高表达基因</li> <li>生物学功能注释</li> <li>转录因子等基因集特异性亚群（更多的生物学功能数据库）</li></ul> <p>一个广为人知的胰腺癌单细胞转录组公共数据库</p> <p>B细胞继续分亚群：<br> <img src="https://s2.loli.net/2024/05/31/pQ7IrZzEtcLF8XY.png" alt="image.png|300"></p> <p><img src="https://s2.loli.net/2024/05/31/EjbV2DFWmPNUAxu.png" alt="image.png|500"></p> <h2 id="聚类"><a href="#聚类" class="header-anchor">#</a> 聚类</h2> <p>聚几个类合适，又时候也是需要谨慎考虑的问题，特别是比较新的组织进行单细胞分群的分析过程</p> <p>ChooseR，一种算法，如有需要，可以详细查查参考一下</p></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=%E5%8D%95%E7%BB%86%E8%83%9E" title="标签">#单细胞</a></div> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/28c669/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">WGCNA</div></a> <a href="/pages/784c69/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Scanpy</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/28c669/" class="prev">WGCNA</a></span> <span class="next"><a href="/pages/784c69/">Scanpy</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/90dbe8/"><div>
            APA相关综述
            <!----></div></a> <span class="date">06-27</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/f4f4b7/"><div>
            胃癌免疫逃逸的决定因素
            <!----></div></a> <span class="date">06-25</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/0a11dd/"><div>
            胖子CAF
            <!----></div></a> <span class="date">06-21</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:2590643635@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/hongliangfang" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2024
    <span>FHL | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.bd488e07.js" defer></script><script src="/assets/js/2.bdf5b8cf.js" defer></script><script src="/assets/js/51.65eba0cc.js" defer></script><script src="/assets/js/3.365ac406.js" defer></script>
  </body>
</html>
